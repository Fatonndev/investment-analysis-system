<div class="data-input-page">
    <h2>Ввод данных проекта</h2>
    
    <?php
    $projectId = $_GET['project_id'] ?? 0;
    
    if ($projectId == 0) {
        echo "<p>Пожалуйста, выберите проект для ввода данных.</p>";
        echo "<p><a href='?action=projects'>Выбрать проект</a></p>";
        return;
    }
    
    $project = $db->fetchOne("SELECT * FROM projects WHERE id = ?", [$projectId]);
    if (!$project) {
        echo "<p>Проект не найден.</p>";
        return;
    }
    
    echo "<h3>Проект: " . htmlspecialchars($project['name']) . "</h3>";
    
    // Get product types from database
    $productTypes = $db->fetchAll("SELECT * FROM product_types ORDER BY name");
    ?>
    
    <div class="data-input-tabs">
        <button class="tab-btn active" data-tab="production">Производственные данные</button>
        <button class="tab-btn" data-tab="costs">Затраты</button>
        <button class="tab-btn" data-tab="prices">Цены на продукцию</button>
        <button class="tab-btn" data-tab="investments">Инвестиции</button>
        <button class="tab-btn" data-tab="import">Импорт данных</button>
    </div>
    
    <div class="tab-content">
        <!-- Production Data Tab -->
        <div id="production-tab" class="tab-pane active">
            <h3>Производственные данные</h3>
            <form method="POST" action="?action=data-input&project_id=<?php echo $projectId; ?>">
                <input type="hidden" name="action" value="add_production">
                <div class="form-row">
                    <div class="form-group">
                        <label for="prod_period">Период (месяц):</label>
                        <input type="month" id="prod_period" name="period" required>
                    </div>
                    <div class="form-group">
                        <label for="product_type">Тип продукции:</label>
                        <select id="product_type" name="product_type" required>
                            <?php foreach ($productTypes as $type): ?>
                                <option value="<?php echo htmlspecialchars($type['name']); ?>"><?php echo htmlspecialchars($type['name']); ?></option>
                            <?php endforeach; ?>
                            <?php if (empty($productTypes)): ?>
                                <option value="Стальные трубы">Стальные трубы</option>
                                <option value="Трубная заготовка">Трубная заготовка</option>
                                <option value="Оцинкованные трубы">Оцинкованные трубы</option>
                                <option value="Специальные трубы">Специальные трубы</option>
                            <?php endif; ?>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="quantity">Объем производства (тонны):</label>
                        <input type="number" id="quantity" name="quantity" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="unit">Единица измерения:</label>
                        <select id="unit" name="unit" required>
                            <option value="тонны">тонны</option>
                            <option value="штуки">штуки</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="revenue">Выручка (руб.):</label>
                        <input type="number" id="revenue" name="revenue" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="variable_costs">Переменные затраты (руб.):</label>
                        <input type="number" id="variable_costs" name="variable_costs" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="fixed_costs">Постоянные затраты (руб.):</label>
                        <input type="number" id="fixed_costs" name="fixed_costs" step="0.01" required>
                    </div>
                </div>
                
                <button type="submit" class="btn-primary">Добавить данные</button>
            </form>
            
            <!-- Display existing production data -->
            <h4>Существующие данные</h4>
            <?php
            $prodData = $db->fetchAll("SELECT * FROM production_data WHERE project_id = ? ORDER BY period DESC", [$projectId]);
            if (!empty($prodData)) {
                echo "<table class='data-table'>";
                echo "<thead><tr><th>Период</th><th>Тип продукции</th><th>Объем</th><th>Ед.изм.</th><th>Выручка</th><th>Перем.затраты</th><th>Пост.затраты</th><th>Действия</th></tr></thead>";
                echo "<tbody>";
                foreach ($prodData as $data) {
                    echo "<tr>";
                    echo "<td>" . $data['period'] . "</td>";
                    echo "<td>" . htmlspecialchars($data['product_type']) . "</td>";
                    echo "<td>" . $data['quantity'] . "</td>";
                    echo "<td>" . htmlspecialchars($data['unit'] ?? '') . "</td>";
                    echo "<td>" . number_format($data['revenue'] ?? 0, 2, '.', ' ') . "</td>";
                    echo "<td>" . number_format($data['variable_costs'] ?? 0, 2, '.', ' ') . "</td>";
                    echo "<td>" . number_format($data['fixed_costs'] ?? 0, 2, '.', ' ') . "</td>";
                    echo "<td><a href='?action=data-input&project_id=$projectId&delete_prod=" . $data['id'] . "' class='btn-small btn-danger' onclick='return confirm(\"Удалить запись?\")'>Удалить</a></td>";
                    echo "</tr>";
                }
                echo "</tbody>";
                echo "</table>";
            } else {
                echo "<p>Нет введенных производственных данных</p>";
            }
            ?>
        </div>
        
        <!-- Costs Tab -->
        <div id="costs-tab" class="tab-pane">
            <h3>Данные о затратах</h3>
            <form method="POST" action="?action=data-input&project_id=<?php echo $projectId; ?>">
                <input type="hidden" name="action" value="add_cost">
                <div class="form-row">
                    <div class="form-group">
                        <label for="cost_period">Период (месяц):</label>
                        <input type="month" id="cost_period" name="period" required>
                    </div>
                    <div class="form-group">
                        <label for="cost_type">Тип затрат:</label>
                        <select id="cost_type" name="cost_type" required onchange="toggleCostFields()">
                            <option value="raw_material">Сырье (сталь)</option>
                            <option value="energy">Энергоносители</option>
                            <option value="logistics">Логистика</option>
                            <option value="labor">Заработная плата</option>
                            <option value="depreciation">Амортизация</option>
                        </select>
                    </div>
                </div>
                
                <div id="raw-material-fields">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="material_type">Тип материала:</label>
                            <select id="material_type" name="material_type">
                                <option value="Сталь">Сталь</option>
                                <option value="Трубы-заготовки">Трубы-заготовки</option>
                                <option value="Покрытия">Покрытия</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="cost_per_unit_raw">Стоимость за единицу (руб.):</label>
                            <input type="number" id="cost_per_unit_raw" name="cost_per_unit" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="quantity_used_raw">Количество использовано:</label>
                            <input type="number" id="quantity_used_raw" name="quantity_used" step="0.01" required>
                        </div>
                    </div>
                </div>
                
                <div id="energy-fields" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="energy_type">Тип энергии:</label>
                            <select id="energy_type" name="energy_type">
                                <option value="Электроэнергия">Электроэнергия</option>
                                <option value="Газ">Газ</option>
                                <option value="Пар">Пар</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="cost_per_unit_energy">Стоимость за единицу (руб.):</label>
                            <input type="number" id="cost_per_unit_energy" name="cost_per_unit" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="quantity_used_energy">Количество использовано:</label>
                            <input type="number" id="quantity_used_energy" name="quantity_used" step="0.01">
                        </div>
                    </div>
                </div>
                
                <div id="logistics-fields" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="logistics_route">Маршрут/Направление:</label>
                            <input type="text" id="logistics_route" name="route" placeholder="например: Москва-Санкт-Петербург">
                        </div>
                        <div class="form-group">
                            <label for="logistics_cost">Стоимость перевозки (руб.):</label>
                            <input type="number" id="logistics_cost" name="cost" step="0.01">
                        </div>
                    </div>
                </div>
                
                <div id="labor-fields" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="labor_department">Отдел/Подразделение:</label>
                            <input type="text" id="labor_department" name="department" placeholder="например: Производство">
                        </div>
                        <div class="form-group">
                            <label for="salary_cost">ФОТ (руб.):</label>
                            <input type="number" id="salary_cost" name="salary_cost" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="benefits">Начисления (руб.):</label>
                            <input type="number" id="benefits" name="benefits" step="0.01">
                        </div>
                    </div>
                </div>
                
                <div id="depreciation-fields" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="asset_name">Наименование актива:</label>
                            <input type="text" id="asset_name" name="asset_name" placeholder="например: Стан прокатный">
                        </div>
                        <div class="form-group">
                            <label for="depreciation_amount">Сумма амортизации (руб.):</label>
                            <input type="number" id="depreciation_amount" name="depreciation_amount" step="0.01">
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn-primary">Добавить затраты</button>
            </form>
            
            <!-- Display existing costs data -->
            <h4>Существующие данные о затратах</h4>
            <?php
            $rawMaterialCosts = $db->fetchAll("SELECT * FROM raw_material_costs WHERE project_id = ? ORDER BY period DESC", [$projectId]);
            $energyCosts = $db->fetchAll("SELECT * FROM energy_costs WHERE project_id = ? ORDER BY period DESC", [$projectId]);
            $logisticsCosts = $db->fetchAll("SELECT * FROM logistics_costs WHERE project_id = ? ORDER BY period DESC", [$projectId]);
            $laborCosts = $db->fetchAll("SELECT * FROM labor_costs WHERE project_id = ? ORDER BY period DESC", [$projectId]);
            $depreciationCosts = $db->fetchAll("SELECT * FROM depreciation_costs WHERE project_id = ? ORDER BY period DESC", [$projectId]);

            if (!empty($rawMaterialCosts) || !empty($energyCosts) || !empty($logisticsCosts) || !empty($laborCosts) || !empty($depreciationCosts)) {
                echo "<table class='data-table'>";
                echo "<thead><tr><th>Период</th><th>Тип затрат</th><th>Детали</th><th>Стоимость</th><th>Доп.информация</th><th>Действия</th></tr></thead>";
                echo "<tbody>";

                foreach ($rawMaterialCosts as $cost) {
                    echo "<tr>";
                    echo "<td>" . date('Y-m', strtotime($cost['period'])) . "</td>";
                    echo "<td>Сырье</td>";
                    echo "<td>" . htmlspecialchars($cost['material_type']) . "</td>";
                    echo "<td>" . number_format($cost['total_cost'], 2, '.', ' ') . "</td>";
                    echo "<td>Ед.стоимость: " . number_format($cost['cost_per_unit'], 2, '.', ' ') . ", Кол-во: " . $cost['quantity_used'] . "</td>";
                    echo "<td><a href='?action=data-input&project_id=$projectId&delete_raw_cost=" . $cost['id'] . "' class='btn-small btn-danger' onclick='return confirm(\"Удалить запись?\")'>Удалить</a></td>";
                    echo "</tr>";
                }

                foreach ($energyCosts as $cost) {
                    echo "<tr>";
                    echo "<td>" . date('Y-m', strtotime($cost['period'])) . "</td>";
                    echo "<td>Энергия</td>";
                    echo "<td>" . htmlspecialchars($cost['energy_type']) . "</td>";
                    echo "<td>" . number_format($cost['total_cost'], 2, '.', ' ') . "</td>";
                    echo "<td>Ед.стоимость: " . number_format($cost['cost_per_unit'], 2, '.', ' ') . ", Кол-во: " . $cost['quantity_used'] . "</td>";
                    echo "<td><a href='?action=data-input&project_id=$projectId&delete_energy_cost=" . $cost['id'] . "' class='btn-small btn-danger' onclick='return confirm(\"Удалить запись?\")'>Удалить</a></td>";
                    echo "</tr>";
                }

                foreach ($logisticsCosts as $cost) {
                    echo "<tr>";
                    echo "<td>" . date('Y-m', strtotime($cost['period'])) . "</td>";
                    echo "<td>Логистика</td>";
                    echo "<td>" . htmlspecialchars($cost['route']) . "</td>";
                    echo "<td>" . number_format($cost['cost'], 2, '.', ' ') . "</td>";
                    echo "<td>-</td>";
                    echo "<td><a href='?action=data-input&project_id=$projectId&delete_logistics_cost=" . $cost['id'] . "' class='btn-small btn-danger' onclick='return confirm(\"Удалить запись?\")'>Удалить</a></td>";
                    echo "</tr>";
                }

                foreach ($laborCosts as $cost) {
                    echo "<tr>";
                    echo "<td>" . date('Y-m', strtotime($cost['period'])) . "</td>";
                    echo "<td>Заработная плата</td>";
                    echo "<td>" . htmlspecialchars($cost['department']) . "</td>";
                    echo "<td>" . number_format($cost['total_cost'], 2, '.', ' ') . "</td>";
                    echo "<td>ФОТ: " . number_format($cost['salary_cost'], 2, '.', ' ') . ", Начисления: " . number_format($cost['benefits'], 2, '.', ' ') . "</td>";
                    echo "<td><a href='?action=data-input&project_id=$projectId&delete_labor_cost=" . $cost['id'] . "' class='btn-small btn-danger' onclick='return confirm(\"Удалить запись?\")'>Удалить</a></td>";
                    echo "</tr>";
                }

                foreach ($depreciationCosts as $cost) {
                    echo "<tr>";
                    echo "<td>" . date('Y-m', strtotime($cost['period'])) . "</td>";
                    echo "<td>Амортизация</td>";
                    echo "<td>" . htmlspecialchars($cost['asset_name']) . "</td>";
                    echo "<td>" . number_format($cost['depreciation_amount'], 2, '.', ' ') . "</td>";
                    echo "<td>-</td>";
                    echo "<td><a href='?action=data-input&project_id=$projectId&delete_depreciation_cost=" . $cost['id'] . "' class='btn-small btn-danger' onclick='return confirm(\"Удалить запись?\")'>Удалить</a></td>";
                    echo "</tr>";
                }

                echo "</tbody>";
                echo "</table>";
            } else {
                echo "<p>Нет введенных данных о затратах</p>";
            }
            ?>
        </div>
        
        <!-- Prices Tab -->
        <div id="prices-tab" class="tab-pane">
            <h3>Цены на готовую продукцию</h3>
            <form method="POST" action="?action=data-input&project_id=<?php echo $projectId; ?>">
                <input type="hidden" name="action" value="add_price">
                <div class="form-row">
                    <div class="form-group">
                        <label for="price_period">Период (месяц):</label>
                        <input type="month" id="price_period" name="period" required>
                    </div>
                    <div class="form-group">
                        <label for="price_product_type">Тип продукции:</label>
                        <select id="price_product_type" name="product_type" required>
                            <?php foreach ($productTypes as $type): ?>
                                <option value="<?php echo htmlspecialchars($type['name']); ?>"><?php echo htmlspecialchars($type['name']); ?></option>
                            <?php endforeach; ?>
                            <?php if (empty($productTypes)): ?>
                                <option value="Стальные трубы">Стальные трубы</option>
                                <option value="Трубная заготовка">Трубная заготовка</option>
                                <option value="Оцинкованные трубы">Оцинкованные трубы</option>
                                <option value="Специальные трубы">Специальные трубы</option>
                            <?php endif; ?>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="size_spec">Типоразмер:</label>
                        <input type="text" id="size_spec" name="size_spec" placeholder="например: 108x4">
                    </div>
                    <div class="form-group">
                        <label for="precision_class">Класс точности:</label>
                        <select id="precision_class" name="precision_class">
                            <option value="обычный">Обычный</option>
                            <option value="повышенный">Повышенный</option>
                            <option value="высокий">Высокий</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="region">Регион сбыта:</label>
                        <input type="text" id="region" name="region" placeholder="например: Москва">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="price_per_unit">Цена за единицу (руб.):</label>
                    <input type="number" id="price_per_unit" name="price_per_unit" step="0.01" required>
                </div>
                
                <button type="submit" class="btn-primary">Добавить цену</button>
            </form>
            
            <!-- Display existing prices -->
            <h4>Существующие цены</h4>
            <?php
            $priceData = $db->fetchAll("SELECT * FROM product_prices WHERE project_id = ? ORDER BY period DESC", [$projectId]);
            if (!empty($priceData)) {
                echo "<table class='data-table'>";
                echo "<thead><tr><th>Период</th><th>Тип продукции</th><th>Типоразмер</th><th>Класс точности</th><th>Регион</th><th>Цена за единицу</th><th>Действия</th></tr></thead>";
                echo "<tbody>";
                foreach ($priceData as $data) {
                    echo "<tr>";
                    echo "<td>" . date('Y-m', strtotime($data['period'])) . "</td>";
                    echo "<td>" . htmlspecialchars($data['product_type']) . "</td>";
                    echo "<td>" . htmlspecialchars($data['size_spec']) . "</td>";
                    echo "<td>" . htmlspecialchars($data['precision_class']) . "</td>";
                    echo "<td>" . htmlspecialchars($data['region']) . "</td>";
                    echo "<td>" . number_format($data['price_per_unit'], 2, '.', ' ') . "</td>";
                    echo "<td><a href='?action=data-input&project_id=$projectId&delete_price=" . $data['id'] . "' class='btn-small btn-danger' onclick='return confirm(\"Удалить запись?\")'>Удалить</a></td>";
                    echo "</tr>";
                }
                echo "</tbody>";
                echo "</table>";
            } else {
                echo "<p>Нет введенных цен на продукцию</p>";
            }
            ?>
        </div>
        
        <!-- Investments Tab -->
        <div id="investments-tab" class="tab-pane">
            <h3>Инвестиционные вложения</h3>
            <form method="POST" action="?action=data-input&project_id=<?php echo $projectId; ?>">
                <input type="hidden" name="action" value="add_investment">
                <div class="form-group">
                    <label for="investment_type">Тип инвестиции:</label>
                    <select id="investment_type" name="investment_type" required>
                        <option value="Оборудование">Оборудование</option>
                        <option value="Модернизация">Модернизация</option>
                        <option value="Строительство">Строительство</option>
                        <option value="Технологии">Технологии</option>
                        <option value="Прочее">Прочее</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="investment_description">Описание:</label>
                    <textarea id="investment_description" name="description" required></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="investment_amount">Сумма (руб.):</label>
                        <input type="number" id="investment_amount" name="amount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="investment_date">Дата вложения:</label>
                        <input type="date" id="investment_date" name="investment_date" required>
                    </div>
                </div>
                
                <button type="submit" class="btn-primary">Добавить инвестицию</button>
            </form>
            
            <!-- Display existing investments data -->
            <h4>Существующие инвестиционные вложения</h4>
            <?php
            $investmentData = $db->fetchAll("SELECT * FROM investment_data WHERE project_id = ? ORDER BY investment_date DESC", [$projectId]);
            if (!empty($investmentData)) {
                echo "<table class='data-table'>";
                echo "<thead><tr><th>Тип инвестиции</th><th>Описание</th><th>Сумма</th><th>Дата вложения</th><th>Действия</th></tr></thead>";
                echo "<tbody>";
                foreach ($investmentData as $data) {
                    echo "<tr>";
                    echo "<td>" . htmlspecialchars($data['investment_type']) . "</td>";
                    echo "<td>" . htmlspecialchars($data['description']) . "</td>";
                    echo "<td>" . number_format($data['amount'], 2, '.', ' ') . "</td>";
                    echo "<td>" . $data['investment_date'] . "</td>";
                    echo "<td><a href='?action=data-input&project_id=$projectId&delete_investment=" . $data['id'] . "' class='btn-small btn-danger' onclick='return confirm(\"Удалить запись?\")'>Удалить</a></td>";
                    echo "</tr>";
                }
                echo "</tbody>";
                echo "</table>";
            } else {
                echo "<p>Нет введенных инвестиционных вложений</p>";
            }
            ?>
        </div>
        
        <!-- Import Data Tab -->
        <div id="import-tab" class="tab-pane">
            <h3>Импорт данных из Excel</h3>
            <form method="POST" enctype="multipart/form-data" action="?action=data-input&project_id=<?php echo $projectId; ?>">
                <input type="hidden" name="action" value="import_excel">
                <div class="form-group">
                    <label for="excel_file">Выберите Excel файл:</label>
                    <input type="file" id="excel_file" name="excel_file" accept=".xls,.xlsx" required>
                </div>
                <div class="form-group">
                    <label for="data_type">Тип данных для импорта:</label>
                    <select id="data_type" name="data_type" required>
                        <option value="production">Производственные данные</option>
                        <option value="costs">Затраты</option>
                        <option value="prices">Цены на продукцию</option>
                        <option value="investments">Инвестиции</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">Импортировать</button>
            </form>
            <p class="help-text">Поддерживаются файлы Excel (.xls, .xlsx). Файл должен содержать правильные заголовки столбцов.</p>
        </div>
    </div>
</div>

