public function calculateProjectAnalysis($projectId, $discountRate = 0.1, $forecastYears = 3) {
        $financialData = $this->getProjectFinancialData($projectId);
        $investmentData = $this->getProjectInvestmentData($projectId);
        
        if (empty($financialData)) {
            return ['error' => 'Не хватает данных для этого проекта'];
        }
        
        // Prepare cash flows
        $cashFlows = [];
        
        $totalRevenue = 0;
        $totalCosts = 0;
        $revenues = [];
        $costs = [];
        $periods = [];
        
        // Extract unique periods from financial data
        foreach ($financialData as $row) {
            $period = $row['period'];
            $periods[] = $period;
        }
        
        // Sort periods to ensure proper chronological order
        sort($periods);
        
        // Calculate total investment amount
        $totalInvestment = 0;
        foreach ($investmentData as $investment) {
            $totalInvestment += floatval($investment['amount']);
        }
        
        // Initialize cash flows - add initial investments as first element
        $initialInvestments = 0;
        
        // Initialize cash flows with zeros for each operational period
        $operationalCashFlows = array_fill(0, count($periods), 0);
        
        // Create a mapping of period to investments for that period
        $periodInvestments = [];
        foreach ($periods as $period) {
            $periodInvestments[$period] = 0;
        }
        
        // Separate investments that occur before or at the first operational period
        $firstOperationalPeriod = !empty($periods) ? min($periods) : null;
        
        foreach ($investmentData as $investment) {
            $investmentDate = $investment['investment_date'];
            $investmentAmount = floatval($investment['amount']);
            
            if ($firstOperationalPeriod && $investmentDate < $firstOperationalPeriod) {
                // Investment occurs before first operational period, add to initial investments
                $initialInvestments += $investmentAmount;
            } else if ($firstOperationalPeriod && $investmentDate == $firstOperationalPeriod) {
                // Investment occurs at the same time as the first operational period, add to initial investments
                $initialInvestments += $investmentAmount;
            } else {
                // Investment occurs during operational periods, add to specific period
                $periodFound = false;
                foreach ($periods as $period) {
                    if ($investmentDate <= $period) {
                        $periodInvestments[$period] += $investmentAmount;
                        $periodFound = true;
                        break;
                    }
                }
                
                if (!$periodFound) {
                    // If investment date doesn't match any operational period, add to last period
                    $lastPeriod = end($periods);
                    $periodInvestments[$lastPeriod] += $investmentAmount;
                }
            }
        }
        
        // Add operating cash flows
        foreach ($financialData as $row) {
            $period = $row['period'];
            $revenue = floatval($row['total_revenue']);
            $periodCosts = floatval($row['total_costs']);
            $profit = $revenue - $periodCosts;

            // Find the index of this period in our sorted periods array
            $periodIndex = array_search($period, $periods);
            if ($periodIndex !== false) {
                // Net operating profit with any investments that occurred in this period
                $operationalCashFlows[$periodIndex] = $profit - $periodInvestments[$period];
                // Reset the investment amount for this period since it's been accounted for
                $periodInvestments[$period] = 0;
            }

            $totalRevenue += $revenue;
            $totalCosts += $periodCosts;
            $revenues[] = $revenue;
            $costs[] = $periodCosts;
        }
        
        // Add any remaining period investments that didn't align with financial data periods
        foreach ($periodInvestments as $period => $investmentAmount) {
            if ($investmentAmount > 0) {
                $periodIndex = array_search($period, $periods);
                if ($periodIndex !== false) {
                    $operationalCashFlows[$periodIndex] -= $investmentAmount;
                }
            }
        }
        
        // Create separate arrays for investments and revenues by period
        // Extend to cover the full forecast horizon
        $periodInvestmentsByPeriod = [];
        $periodRevenuesByPeriod = [];

        // Initialize arrays with zeros for the full forecast horizon
        for ($i = 0; $i < $forecastYears; $i++) {
            $periodInvestmentsByPeriod[$i] = 0;
            $periodRevenuesByPeriod[$i] = 0;
        }

        // Process investment data to get investments by period
        foreach ($investmentData as $investment) {
            $investmentDate = $investment['investment_date'];
            $investmentAmount = floatval($investment['amount']);

            if ($firstOperationalPeriod && $investmentDate < $firstOperationalPeriod) {
                // Initial investments are handled separately
                continue;
            } else {
                // Find which period this investment belongs to
                $periodFound = false;
                foreach ($periods as $periodIndex => $period) {
                    if ($investmentDate <= $period) {
                        // Map to forecast horizon if needed
                        $mappedIndex = min($periodIndex, $forecastYears - 1);
                        $periodInvestmentsByPeriod[$mappedIndex] += $investmentAmount;
                        $periodFound = true;
                        break;
                    }
                }

                if (!$periodFound) {
                    // If investment date doesn't match any operational period, add to last period
                    $lastPeriodIndex = min(count($periods) - 1, $forecastYears - 1);
                    $periodInvestmentsByPeriod[$lastPeriodIndex] += $investmentAmount;
                }
            }
        }

        // Add revenues and costs to the revenue array by period
        foreach ($financialData as $row) {
            $period = $row['period'];
            $revenue = floatval($row['total_revenue']);
            $periodCosts = floatval($row['total_costs']);
            $netRevenue = $revenue - $periodCosts; // Net revenue after costs

            $periodIndex = array_search($period, $periods);
            if ($periodIndex !== false) {
                // Map to forecast horizon if needed
                $mappedIndex = min($periodIndex, $forecastYears - 1);
                $periodRevenuesByPeriod[$mappedIndex] = $netRevenue;
            }
        }

        // If we have fewer periods than forecast years, extend with projected values
        if (count($periods) < $forecastYears) {
            // Calculate average revenue and cost per period from existing data
            $avgRevenue = count($revenues) > 0 ? array_sum($revenues) / count($revenues) : 0;
            $avgCost = count($costs) > 0 ? array_sum($costs) / count($costs) : 0;
            $avgNetRevenue = $avgRevenue - $avgCost;

            // Fill remaining periods with projected values
            for ($i = count($periods); $i < $forecastYears; $i++) {
                $periodRevenuesByPeriod[$i] = $avgNetRevenue;
            }
        }

        // Create cash flows array that includes initial investment and all operational periods
        // We'll have initial investment at index 0, followed by cash flows for each operational period
        $cashFlows = [];

        // Add initial investments to the first period
        $cashFlows[] = -$initialInvestments;

        // Add operational cash flows for each period up to the forecast horizon (including any investments in those periods)
        for ($i = 0; $i < $forecastYears; $i++) {
            if ($i < count($operationalCashFlows)) {
                // Use actual operational cash flow if available
                $cashFlows[] = $operationalCashFlows[$i];
            } else {
                // Use projected cash flow based on average if we exceed actual data
                $avgRevenue = count($revenues) > 0 ? array_sum($revenues) / count($revenues) : 0;
                $avgCost = count($costs) > 0 ? array_sum($costs) / count($costs) : 0;
                $avgNetRevenue = $avgRevenue - $avgCost;
                $cashFlows[] = $avgNetRevenue;
            }
        }

        // Calculate total profit based on forecast horizon
        $projectedTotalRevenue = $totalRevenue;
        $projectedTotalCosts = $totalCosts;

        // Add projected revenue and costs for remaining forecast years
        if (count($periods) < $forecastYears) {
            $avgRevenue = count($revenues) > 0 ? array_sum($revenues) / count($revenues) : 0;
            $avgCost = count($costs) > 0 ? array_sum($costs) / count($costs) : 0;

            $remainingPeriods = $forecastYears - count($periods);
            $projectedTotalRevenue += $avgRevenue * $remainingPeriods;
            $projectedTotalCosts += $avgCost * $remainingPeriods;
        }

        $totalProfit = $projectedTotalRevenue - $projectedTotalCosts;

        // Calculate metrics
        $roi = $this->calculateROI($totalProfit, $projectedTotalCosts);
        $npv = $this->calculateNPV($cashFlows, $discountRate); // Use the passed discount rate
        $irr = $this->calculateIRR($cashFlows);
        $paybackPeriod = $this->calculatePaybackPeriod($cashFlows);

        // Break-even analysis
        $avgRevenuePerPeriod = count($financialData) > 0 ? $totalRevenue / count($financialData) : 0;
        $avgCostsPerPeriod = count($financialData) > 0 ? $totalCosts / count($financialData) : 0;
        $avgFixedCostsPerPeriod = 0; // Would need more specific data

        // Sensitivity analysis
        $baseData = [
            'revenue' => $totalRevenue,
            'costs' => $totalCosts,
            'investment' => $totalInvestment
        ];
        $sensitivityResults = $this->performSensitivityAnalysis($baseData);

        // Forecasting
        $forecastScenarios = $this->generateForecastScenarios($revenues, $forecastYears);

        // Create period labels for the forecast horizon
        $forecastPeriods = [];
        for ($i = 1; $i <= $forecastYears; $i++) {
            $forecastPeriods[] = $i;
        }

        return [
            'cash_flows' => $cashFlows,
            'total_revenue' => $projectedTotalRevenue,
            'total_costs' => $projectedTotalCosts,
            'total_profit' => $totalProfit,
            'total_investment' => $totalInvestment,
            'roi' => $roi,
            'npv' => $npv,
            'irr' => $irr,
            'payback_period' => $paybackPeriod,
            'sensitivity_analysis' => $sensitivityResults,
            'forecast_scenarios' => $forecastScenarios,
            'periods' => $forecastPeriods,  // Updated to reflect forecast horizon
            'initial_investments' => $initialInvestments,
            'operational_cash_flows' => $operationalCashFlows,
            'period_investments_by_period' => $periodInvestmentsByPeriod,
            'period_revenues_by_period' => $periodRevenuesByPeriod
        ];
    }